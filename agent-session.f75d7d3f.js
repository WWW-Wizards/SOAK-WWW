!function(){function e(e,t,i,s){Object.defineProperty(e,t,{get:i,set:s,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire5e30,i=t.register;i("cJYgA",function(i,s){e(i.exports,"setupAgentSession",function(){return c});var r=t("jT9mC"),n=t("aJa9J"),o=t("8auZx"),a=t("9rkUJ"),h=t("gUikG"),u=t("kWizy");function c(e){if(e.runtime.session)return e.runtime.session;let t=e.init.session;e.runtime.session=new(0,a.SessionEntity)({agentIdentifier:e.agentIdentifier,key:u.DEFAULT_KEY,storage:new(0,h.LocalStorage),expiresMs:t?.expiresMs,inactiveMs:t?.inactiveMs});let i=e.runtime.session.state.custom;i&&(e.info.jsAttributes={...e.info.jsAttributes,...i});let s=n.ee.get(e.agentIdentifier);return(0,o.registerHandler)("api-setCustomAttribute",(t,i,s)=>{e.runtime.session.syncCustomAttribute(i,s)},"session",s),(0,o.registerHandler)("api-setUserId",(t,i,s)=>{e.runtime.session.syncCustomAttribute(i,s)},"session",s),(0,r.drain)(e.agentIdentifier,"session"),e.runtime.session}}),i("9rkUJ",function(i,s){e(i.exports,"SessionEntity",function(){return T});var r=t("sAPpv"),n=t("73gWV"),o=t("gSI6b"),a=t("aJa9J"),h=t("iOJZe"),u=t("7CBaz"),c=t("kWizy"),l=t("4oo82"),d=t("66LGH"),f=t("7IlRp"),m=t("dpdfa"),p=t("02hiY"),S=t("gUmiN"),g=t("bXLOi"),E=t("fXG8h");let y={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:c.MODE.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:c.MODE.OFF,traceHarvestStarted:!1,loggingMode:E.LOGGING_MODE.OFF,serverTimeDiff:null,custom:{},numOfResets:0};class T{constructor(e){let{agentIdentifier:t,key:i,storage:s}=e;if(!t||!i||!s)throw Error("Missing required field(s):".concat(!t?" agentID":"").concat(!i?" key":"").concat(s?"":" storage"));this.agentIdentifier=t,this.storage=s,this.state={},this.key=i,this.ee=a.ee.get(t),(0,d.wrapEvents)(this.ee),this.setup(e),u.isBrowserScope&&(0,g.windowAddEventListener)("storage",e=>{if(e.key===this.lookupKey){let t="string"==typeof e.newValue?JSON.parse(e.newValue):e.newValue;this.sync(t),this.ee.emit(c.SESSION_EVENTS.UPDATE,[c.SESSION_EVENT_TYPES.CROSS_TAB,this.state])}})}setup({value:e=(0,r.generateRandomHexString)(16),expiresMs:t=c.DEFAULT_EXPIRES_MS,inactiveMs:i=c.DEFAULT_INACTIVE_MS,numOfResets:s=0}){let n={serverTimeDiff:this.state.serverTimeDiff||y.serverTimeDiff};this.state={},this.sync({...y,...n}),this.state.value=e,this.expiresMs=t,this.inactiveMs=i;let o=this.read();t?(this.state.expiresAt=o?.expiresAt||this.getFutureTimestamp(t),this.state.numOfResets=o?.numOfResets||s,this.expiresTimer=new(0,h.Timer)({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,i?(this.state.inactiveAt=o?.inactiveAt||this.getFutureTimestamp(i),this.inactiveTimer=new(0,l.InteractionTimer)({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(c.SESSION_EVENTS.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(c.SESSION_EVENTS.PAUSE),this.write((0,f.getModeledObject)(this.state,y))},ee:this.ee,refreshEvents:["click","keydown","scroll"],readStorage:()=>this.storage.get(this.lookupKey)},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew||=!Object.keys(o).length,this.isNew?this.write((0,f.getModeledObject)(this.state,y),!0):this.sync(o),this.initialized=!0,this.ee.emit(c.SESSION_EVENTS.STARTED,[this.isNew])}get lookupKey(){return"".concat(c.PREFIX,"_").concat(this.key)}sync(e){Object.assign(this.state,e)}read(){try{let e=this.storage.get(this.lookupKey);if(!e)return{};let t="string"==typeof e?JSON.parse(e):e;if(this.isInvalid(t))return{};if(this.isExpired(t.expiresAt))return this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset();if(this.isExpired(t.inactiveAt))return this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset();return t}catch(e){return(0,n.warn)(10,e),{}}}write(e){try{if(!e||"object"!=typeof e)return;return e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,(0,o.stringify)(this.state)),this.ee.emit(c.SESSION_EVENTS.UPDATE,[c.SESSION_EVENT_TYPES.SAME_TAB,this.state]),e}catch(e){return(0,n.warn)(11,e),null}}reset(){try{return this.initialized&&this.ee.emit(c.SESSION_EVENTS.RESET),this.storage.remove(this.lookupKey),this.inactiveTimer?.abort?.(),this.expiresTimer?.clear?.(),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs,numOfResets:++this.state.numOfResets}),this.read()}catch(e){return{}}}refresh(){let e=this.read();this.write({...e,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isAfterSessionExpiry(e){return this.state.numOfResets>0||"number"==typeof e&&"number"==typeof this.state.expiresAt&&e>=this.state.expiresAt}isExpired(e){return Date.now()>e}isInvalid(e){return!Object.keys(y).every(t=>Object.keys(e).includes(t))}collectSM(e,t,i){let s,r;"duration"===e&&(s=this.getDuration(t,i),r="Session/Duration/Ms"),"expired"===e&&(r="Session/Expired/Seen"),"inactive"===e&&(r="Session/Inactive/Seen"),r&&(0,m.handle)(p.SUPPORTABILITY_METRIC_CHANNEL,[r,s],void 0,S.FEATURE_NAMES.metrics,this.ee)}getDuration(e=this.state,t){let i=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-i}getFutureTimestamp(e){return Date.now()+e}syncCustomAttribute(e,t){if(u.isBrowserScope)if(null===t){let t=this.read();t.custom&&(delete t.custom[e],this.write({...t}))}else{let i=this.read();this.custom={...i?.custom||{},[e]:t},this.write({...i,custom:this.custom})}}}}),i("iOJZe",function(t,i){e(t.exports,"Timer",function(){return s});class s{constructor(e,t){if(!e.onEnd)throw Error("onEnd handler is required");if(!t)throw Error("ms duration is required");this.onEnd=e.onEnd,this.initialMs=t,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,t)}create(e,t){return this.timer&&this.clear(),setTimeout(()=>e?e():this.onEnd(),t||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}}),i("4oo82",function(i,s){e(i.exports,"InteractionTimer",function(){return h});var r=t("iOJZe"),n=t("4mnMC"),o=t("8oG2U"),a=t("7CBaz");class h extends r.Timer{constructor(e,t){super(e,t),this.onPause="function"==typeof e.onPause?e.onPause:()=>{},this.onRefresh="function"==typeof e.onRefresh?e.onRefresh:()=>{},this.onResume="function"==typeof e.onResume?e.onResume:()=>{},this.readStorage=e.readStorage,this.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch(e){}if(a.isBrowserScope&&e.ee){if(e.ee){this.ee=e.ee;let t=(0,o.debounce)(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=i=>{e.refreshEvents.includes(i?.[0]?.type)&&t()},e.ee.on("fn-end",this.refreshHandler)}(0,n.subscribeToVisibilityChange)(e=>{"hidden"===e?this.pause():this.resume()},!1,!1,this.abortController?.signal)}}abort(){this.clear(),this.abortController?.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){try{let t=this.readStorage(),i="string"==typeof t?JSON.parse(t):t;e(i.expiresAt)||e(i.inactiveAt)?this.end():(this.refresh(),this.onResume())}catch(e){this.end()}function e(e){return Date.now()>e}}refresh(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}}),i("gUikG",function(t,i){e(t.exports,"LocalStorage",function(){return s});class s{get(e){try{return localStorage.getItem(e)||void 0}catch(e){return""}}set(e,t){try{if(null==t)return this.remove(e);return localStorage.setItem(e,t)}catch(e){}}remove(e){try{localStorage.removeItem(e)}catch(e){}}}})}();
//# sourceMappingURL=agent-session.f75d7d3f.js.map
