function e(e,t,i,s){Object.defineProperty(e,t,{get:i,set:s,enumerable:!0,configurable:!0})}function t(e){return import(i+(e=s.i?.[e]||e))}var i="./",s=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire5e30,r=s.register;r("8rBbr",function(t,i){e(t.exports,"Aggregate",function(){return R});var r=s("4he1m"),o=s("6bsRh"),n=s("3DmF0"),a=s("5GJZE"),h=s("ikySP"),l=s("jkuUu"),d=s("9EKMI"),c=s("4wUr4"),p=s("44Lnf"),u=s("8KO5M"),S=s("7tsml"),m=s("1Z3KE"),g=s("24qgc"),y=s("iNTSX"),f=s("jWywI"),E=s("1orxZ");class R extends n.AggregateBase{static featureName=o.FEATURE_NAME;mode=p.MODE.OFF;constructor(e,t){super(e,o.FEATURE_NAME),this.initialized=!1,this.blocked=!1,this.gzipper=void 0,this.u8=void 0,this.entitled=!1,this.timeKeeper=void 0,this.recorder=t?.recorder,this.errorNoticed=t?.errorNoticed||!1,this.harvestOpts.raw=!0,this.isSessionTrackingEnabled=(0,E.canEnableSessionTracking)(e.init)&&!!e.runtime.session,this.reportSupportabilityMetric("Config/SessionReplay/Enabled"),this.ee.on(p.SESSION_EVENTS.RESET,()=>{this.abort(o.ABORT_REASONS.RESET)}),this.ee.on(p.SESSION_EVENTS.PAUSE,()=>{this.recorder?.stopRecording()}),this.ee.on(p.SESSION_EVENTS.RESUME,()=>{this.recorder&&(this.mode=e.runtime.session.state.sessionReplayMode,this.initialized&&this.mode!==p.MODE.OFF&&this.recorder?.startRecording())}),this.ee.on(p.SESSION_EVENTS.UPDATE,(e,t)=>{this.recorder&&this.initialized&&!this.blocked&&e===p.SESSION_EVENT_TYPES.CROSS_TAB&&(this.mode!==p.MODE.OFF&&t.sessionReplayMode===p.MODE.OFF&&this.abort(o.ABORT_REASONS.CROSS_TAB),this.mode=t.sessionReplayMode)}),(0,r.registerHandler)(o.SR_EVENT_EMITTER_TYPES.PAUSE,()=>{this.forceStop(this.mode===p.MODE.FULL)},this.featureName,this.ee),(0,r.registerHandler)(o.SR_EVENT_EMITTER_TYPES.ERROR_DURING_REPLAY,e=>{this.handleError(e)},this.featureName,this.ee);let{error_sampling_rate:i,sampling_rate:s,autoStart:n,block_selector:h,mask_text_selector:l,mask_all_inputs:d,inline_images:c,collect_fonts:u}=e.init.session_replay;this.waitForFlags(["srs","sr"]).then(([e,t])=>{if(this.entitled=!!t,!this.entitled){this.deregisterDrain(),this.recorder?.recording&&(this.abort(o.ABORT_REASONS.ENTITLEMENTS),this.reportSupportabilityMetric("SessionReplay/EnabledNotEntitled/Detected"));return}this.drain(),this.initializeRecording(e)}).then(()=>{if(this.mode===p.MODE.OFF)for(this.recorder?.stopRecording();this.recorder?.getEvents().events.length;)this.recorder?.clearBuffer?.();a.sharedChannel.onReplayReady(this.mode)}),n||this.reportSupportabilityMetric("Config/SessionReplay/AutoStart/Modified"),!0===u&&this.reportSupportabilityMetric("Config/SessionReplay/CollectFonts/Modified"),!0===c&&this.reportSupportabilityMetric("Config/SessionReplay/InlineImages/Modifed"),!0!==d&&this.reportSupportabilityMetric("Config/SessionReplay/MaskAllInputs/Modified"),"[data-nr-block]"!==h&&this.reportSupportabilityMetric("Config/SessionReplay/BlockSelector/Modified"),"*"!==l&&this.reportSupportabilityMetric("Config/SessionReplay/MaskTextSelector/Modified"),this.reportSupportabilityMetric("Config/SessionReplay/SamplingRate/Value",s),this.reportSupportabilityMetric("Config/SessionReplay/ErrorSamplingRate/Value",i)}replayIsActive(){return!!(this.recorder&&this.mode===p.MODE.FULL&&!this.blocked&&this.entitled)}handleError(e){this.recorder&&(this.recorder.currentBufferTarget.hasError=!0),this.mode===p.MODE.ERROR&&d.globalScope?.document.visibilityState==="visible"&&this.switchToFull()}switchToFull(){this.entitled&&!this.blocked&&(this.mode=p.MODE.FULL,this.recorder&&this.initialized?(this.recorder.recording||this.recorder.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})):this.initializeRecording(p.MODE.FULL,!0))}async initializeRecording(e,t){if(this.initialized=!0,!this.entitled)return;let{session:i,timeKeeper:r}=this.agentRef.runtime;if(this.timeKeeper=r,this.recorder?.parent.trigger===o.TRIGGERS.API&&this.recorder?.recording?this.mode=p.MODE.FULL:i.isNew||t?this.mode=e:this.mode=i.state.sessionReplayMode,this.mode!==p.MODE.OFF){if(this.recorder)this.recorder.parent=this;else try{let{Recorder:e}=await s("8tHcq");this.recorder=new e(this),this.recorder.currentBufferTarget.hasError=this.errorNoticed}catch(e){return this.abort(o.ABORT_REASONS.IMPORT)}this.mode===p.MODE.ERROR&&this.errorNoticed&&(this.mode=p.MODE.FULL),this.mode===p.MODE.FULL&&this.recorder?.getEvents().type==="preloaded"&&this.prepUtils().then(()=>this.agentRef.runtime.harvester.triggerHarvestFor(this)),await this.prepUtils(),this.recorder.recording||this.recorder.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}}async prepUtils(){try{let{gzipSync:e,strToU8:t}=await s("7YYUV");this.gzipper=e,this.u8=t}catch(e){}}makeHarvestPayload(e){let t={targetApp:void 0,payload:void 0};if(this.mode!==p.MODE.FULL||this.blocked||!this.recorder||!this.timeKeeper?.ready||!this.recorder.hasSeenSnapshot)return;let i=this.recorder.getEvents();if(!i.events.length)return;let s=this.getHarvestContents(i);if(!s.body.length)return this.recorder.clearBuffer(),[t];this.reportSupportabilityMetric("SessionReplay/Harvest/Attempts");let r=0;return(this.gzipper&&this.u8?(s.body=this.gzipper(this.u8("[".concat(s.body.map(({__serialized:e,...t})=>{if(t.__newrelic&&e)return e;let i={...t};return i.__newrelic||(i.__newrelic=(0,g.buildNRMetaNode)(t.timestamp,this.timeKeeper),i.timestamp=this.timeKeeper.correctAbsoluteTimestamp(t.timestamp)),(0,u.stringify)(i)}).join(","),"]"))),r=s.body.length):(s.body=s.body.map(({__serialized:e,...t})=>{if(t.__newrelic)return t;let i={...t};return i.__newrelic=(0,g.buildNRMetaNode)(t.timestamp,this.timeKeeper),i.timestamp=this.timeKeeper.correctAbsoluteTimestamp(t.timestamp),i}),r=(0,u.stringify)(s.body).length),r>y.MAX_PAYLOAD_SIZE)?this.abort(o.ABORT_REASONS.TOO_BIG,r):(this.agentRef.runtime.session.state.sessionReplaySentFirstChunk||this.syncWithSessionManager({sessionReplaySentFirstChunk:!0}),this.recorder.clearBuffer(),"preloaded"===i.type&&this.agentRef.runtime.harvester.triggerHarvestFor(this),t.payload=s),[t]}getCorrectedTimestamp(e){if(e?.timestamp)return e.__newrelic?e.timestamp:this.timeKeeper.correctAbsoluteTimestamp(e.timestamp)}getHarvestContents(e){let t=(e??=this.recorder.getEvents()).events,i=this.agentRef.runtime,s=this.agentRef.info.jsAttributes?.["enduser.id"];t?.[0]?.type===o.RRWEB_EVENT_TYPES.FullSnapshot&&this.recorder.lastMeta&&(e.hasMeta=!0,t.unshift(this.recorder.lastMeta),this.recorder.lastMeta=void 0),t[t.length-1]?.type===o.RRWEB_EVENT_TYPES.Meta&&(this.recorder.lastMeta=t[t.length-1],t=t.slice(0,t.length-1),e.hasMeta=!!t.find(e=>e.type===o.RRWEB_EVENT_TYPES.Meta));let r=(0,m.now)(),n=this.getCorrectedTimestamp(t[0]),a=this.getCorrectedTimestamp(t[t.length-1]),l=n||Math.floor(this.timeKeeper.correctAbsoluteTimestamp(e.cycleTimestamp)),d=a||Math.floor(this.timeKeeper.correctRelativeTimestamp(r)),p=i.appMetadata?.agents?.[0]||{};return{qs:{browser_monitoring_key:this.agentRef.info.licenseKey,type:"SessionReplay",app_id:this.agentRef.info.applicationID,protocol_version:"0",timestamp:l,attributes:(0,h.obj)({...!!this.gzipper&&!!this.u8&&{content_encoding:"gzip"},...p.entityGuid&&{entityGuid:p.entityGuid},harvestId:[i.session?.state.value,i.ptid,i.harvestCount].filter(e=>e).join("_"),"replay.firstTimestamp":l,"replay.lastTimestamp":d,"replay.nodes":t.length,"session.durationMs":i.session.getDuration(),agentVersion:i.version,session:i.session.state.value,rst:r,hasMeta:e.hasMeta||!1,hasSnapshot:e.hasSnapshot||!1,hasError:e.hasError||!1,isFirstChunk:!1===i.session.state.sessionReplaySentFirstChunk,decompressedBytes:e.payloadBytesEstimation,invalidStylesheetsDetected:S.stylesheetEvaluator.invalidStylesheetsDetected,inlinedAllStylesheets:e.inlinedAllStylesheets,"rrweb.version":c.RRWEB_VERSION,"payload.type":e.type,...s&&{"enduser.id":this.obfuscator.obfuscateString(s)},currentUrl:this.obfuscator.obfuscateString((0,f.cleanURL)(""+location))},o.QUERY_PARAM_PADDING).substring(1)},body:t}}postHarvestCleanup(e){429===e.status&&this.abort(o.ABORT_REASONS.TOO_MANY)}forceStop(e){e&&this.agentRef.runtime.harvester.triggerHarvestFor(this),this.mode=p.MODE.OFF,this.recorder?.stopRecording?.(),this.syncWithSessionManager({sessionReplayMode:this.mode})}abort(e={},t){for((0,l.warn)(33,e.message),this.reportSupportabilityMetric("SessionReplay/Abort/".concat(e.sm),t),this.blocked=!0,this.mode=p.MODE.OFF,this.recorder?.stopRecording?.(),this.syncWithSessionManager({sessionReplayMode:this.mode}),this.recorder?.clearTimestamps?.();this.recorder?.getEvents().events.length;)this.recorder?.clearBuffer?.()}syncWithSessionManager(e={}){this.isSessionTrackingEnabled&&this.agentRef.runtime.session.write(e)}}}),r("5GJZE",function(t,i){let s;e(t.exports,"sharedChannel",function(){return o});let r=new Promise(e=>{s=e}),o=Object.freeze({onReplayReady:s,sessionReplayInitialized:r})}),r("7tsml",function(t,i){e(t.exports,"stylesheetEvaluator",function(){return a});var r=s("juL0p"),o=s("9EKMI");class n{#e=new WeakSet;#t=[];invalidStylesheetsDetected=!1;failedToFix=0;evaluate(){let e=0;if(this.#t=[],o.isBrowserScope){for(let t=0;t<Object.keys(document.styleSheets).length;t++)if(!this.#e.has(document.styleSheets[t])&&document.styleSheets[t]instanceof CSSStyleSheet){this.#e.add(document.styleSheets[t]);try{document.styleSheets[t].cssRules}catch(i){if(!document.styleSheets[t].href)return;e++,this.#t.push(document.styleSheets[t])}}}return e&&(this.invalidStylesheetsDetected=!0),e}async fix(){await Promise.all(this.#t.map(e=>this.#i(e))),this.#t=[];let e=this.failedToFix;return this.failedToFix=0,e}async #i(e){if(e?.href)try{let t=await (0,r.gosNREUMOriginals)().o.FETCH.bind(window)(e.href);if(!t.ok)return void this.failedToFix++;let i=await t.text();try{let t=new CSSStyleSheet;await t.replace(i),Object.defineProperty(e,"cssRules",{get:()=>t.cssRules}),Object.defineProperty(e,"rules",{get:()=>t.rules})}catch(t){Object.defineProperty(e,"cssText",{get:()=>i}),this.failedToFix++}}catch(e){this.failedToFix++}}}let a=new n}),r("8tHcq",function(e,i){e.exports=Promise.all([t("bolVv"),t("7qhnc")]).then(()=>s("laqLT"))}),r("7YYUV",function(e,i){e.exports=t("gYIeX").then(()=>s("hIp1Z"))});
//# sourceMappingURL=aggregate.cfb7ae34.js.map
