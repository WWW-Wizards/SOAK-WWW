function e(e,t,s,i){Object.defineProperty(e,t,{get:s,set:i,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire5e30,s=t.register;s("9ckjO",function(s,i){e(s.exports,"Aggregate",function(){return d});var r=t("4he1m"),n=t("adIx8"),a=t("3DmF0"),o=t("4xyhJ"),h=t("ikySP"),c=t("9EKMI"),u=t("44Lnf"),l=t("hcIxM"),m=t("jWywI");class d extends a.AggregateBase{static featureName=n.FEATURE_NAME;constructor(e){super(e,n.FEATURE_NAME),this.harvestOpts.raw=!0,this.entitled=void 0,this.everHarvested=!1,this.harvesting=!1,this.events=new(0,o.TraceStorage)(this),this.waitForFlags(["sts","st"]).then(([e,t])=>this.initialize(e,t))}initialize(e,t,s){return(this.entitled??=t,this.entitled||(this.blocked=!0),this.blocked||(this.initialized||(this.initialized=!0,this.ptid=this.agentRef.runtime.ptid,this.sessionId=this.agentRef.runtime.session?.state.value,this.ee.on(u.SESSION_EVENTS.RESET,()=>{this.blocked||this.abort(1)}),this.ee.on(u.SESSION_EVENTS.UPDATE,(e,t)=>{this.blocked||(this.mode!==u.MODE.FULL&&(t.sessionReplayMode===u.MODE.FULL||t.sessionTraceMode===u.MODE.FULL)&&this.switchToFull(),(this.sessionId!==t.value||"cross-tab"===e&&t.sessionTraceMode===u.MODE.OFF)&&this.abort(2))}),"undefined"!=typeof PerformanceNavigationTiming?this.events.storeTiming(c.globalScope.performance?.getEntriesByType?.("navigation")[0]):this.events.storeTiming(c.globalScope.performance?.timing,!0)),this.agentRef.runtime.session.isNew||s?this.mode=e:this.mode=this.agentRef.runtime.session.state.sessionTraceMode,this.mode===u.MODE.OFF))?this.deregisterDrain():void(this.timeKeeper??=this.agentRef.runtime.timeKeeper,(0,r.registerHandler)("bst",(...e)=>this.events.storeEvent(...e),this.featureName,this.ee),(0,r.registerHandler)("bstResource",(...e)=>this.events.storeResources(...e),this.featureName,this.ee),(0,r.registerHandler)("bstHist",(...e)=>this.events.storeHist(...e),this.featureName,this.ee),(0,r.registerHandler)("bstXhrAgg",(...e)=>this.events.storeXhrAgg(...e),this.featureName,this.ee),(0,r.registerHandler)("bstApi",(...e)=>this.events.storeSTN(...e),this.featureName,this.ee),(0,r.registerHandler)("trace-jserror",(...e)=>this.events.storeErrorAgg(...e),this.featureName,this.ee),(0,r.registerHandler)("pvtAdded",(...e)=>this.events.processPVT(...e),this.featureName,this.ee),this.mode!==u.MODE.FULL&&(0,r.registerHandler)("trace-jserror",()=>{this.mode===u.MODE.ERROR&&this.switchToFull()},this.featureName,this.ee),this.agentRef.runtime.session.write({sessionTraceMode:this.mode}),this.drain())}preHarvestChecks(){if(this.mode===u.MODE.FULL&&this.timeKeeper?.ready&&this.agentRef.runtime.session)return this.sessionId===this.agentRef.runtime.session.state.value&&this.ptid===this.agentRef.runtime.ptid||void this.abort(3)}serializer({stns:e}){if(e.length)return this.everHarvested=!0,(0,l.applyFnToProps)(e,this.obfuscator.obfuscateString.bind(this.obfuscator),"string")}queryStringsBuilder({stns:e,earliestTimeStamp:t,latestTimeStamp:s}){let i=!this.agentRef.runtime.session.state.traceHarvestStarted;i&&this.agentRef.runtime.session.write({traceHarvestStarted:!0});let r=1===this.agentRef.runtime.session.state.sessionReplayMode,n=this.agentRef.info.jsAttributes["enduser.id"],a=this.agentRef.runtime.appMetadata.agents?.[0]?.entityGuid;return{browser_monitoring_key:this.agentRef.info.licenseKey,type:"BrowserSessionChunk",app_id:this.agentRef.info.applicationID,protocol_version:"0",timestamp:Math.floor(this.timeKeeper.correctRelativeTimestamp(t)),attributes:(0,h.obj)({...a&&{entityGuid:a},harvestId:"".concat(this.agentRef.runtime.session.state.value,"_").concat(this.agentRef.runtime.ptid,"_").concat(this.agentRef.runtime.harvestCount),"trace.firstTimestamp":Math.floor(this.timeKeeper.correctRelativeTimestamp(t)),"trace.lastTimestamp":Math.floor(this.timeKeeper.correctRelativeTimestamp(s)),"trace.nodes":e.length,"trace.originTimestamp":this.timeKeeper.correctedOriginTime,agentVersion:this.agentRef.runtime.version,...i&&{firstSessionHarvest:i},...r&&{hasReplay:r},ptid:"".concat(this.ptid),session:"".concat(this.sessionId),...n&&{"enduser.id":this.obfuscator.obfuscateString(n)},currentUrl:this.obfuscator.obfuscateString((0,m.cleanURL)(""+location))},5e3).substring(1)}}switchToFull(){if(this.mode===u.MODE.FULL||!this.entitled||this.blocked)return;let e=this.mode;if(this.mode=u.MODE.FULL,this.agentRef.runtime.session.write({sessionTraceMode:this.mode}),e===u.MODE.OFF||!this.initialized)return this.initialize(this.mode,this.entitled);this.initialized&&(this.events.trimSTNs(3e4),this.agentRef.runtime.harvester.triggerHarvestFor(this))}abort(){this.blocked=!0,this.mode=u.MODE.OFF,this.agentRef.runtime.session.write({sessionTraceMode:this.mode}),this.events.clear()}}}),s("4xyhJ",function(s,i){e(s.exports,"TraceStorage",function(){return p});var r=t("9EKMI"),n=t("44Lnf"),a=t("1Z3KE"),o=t("5qa2T"),h=t("aDRsS"),c=t("adIx8"),u=t("6xUcd");let l="function"==typeof r.globalScope.PerformanceObserver,m={global:{mouseup:!0,mousedown:!0,mousemove:!0},window:{load:!0,pagehide:!0},xhrOriginMissing:{ignoreAll:!0}},d={typing:[1e3,2e3],scrolling:[100,1e3],mousing:[1e3,2e3],touching:[1e3,2e3]};class p{nodeCount=0;trace={};earliestTimeStamp=1/0;latestTimeStamp=0;prevStoredEvents=new Set;#e;constructor(e){this.parent=e}isAfterSessionExpiry(e){return this.parent.agentRef.runtime?.session?.isAfterSessionExpiry((this.parent.timeKeeper?.ready&&this.parent.timeKeeper.convertRelativeTimestamp(e))??void 0)}storeSTN(e){if(!this.parent.blocked&&(!(this.nodeCount>=c.MAX_NODES_PER_HARVEST)||this.parent.mode===n.MODE.ERROR&&0!==this.trimSTNs(3e4))){if(this.isAfterSessionExpiry(e.s))return void this.parent.reportSupportabilityMetric("Session/Expired/SessionTrace/Seen");this.trace[e.n]?this.trace[e.n].push(e):this.trace[e.n]=[e],e.s<this.earliestTimeStamp&&(this.earliestTimeStamp=e.s),e.s>this.latestTimeStamp&&(this.latestTimeStamp=e.s),this.nodeCount++}}trimSTNs(e){let t=0,s=Math.max((0,a.now)()-e,0);return Object.keys(this.trace).forEach(e=>{let i=this.trace[e],r=i.findIndex(e=>s<=e.e);0!==r&&(r<0?(r=i.length,delete this.trace[e]):i.splice(0,r),this.nodeCount-=r,t+=r)}),t}takeSTNs(){l||this.storeResources(r.globalScope.performance?.getEntriesByType?.("resource"));let e=Object.entries(this.trace).flatMap(([e,t])=>{if(!(e in d))return t;let s=this.smearEvtsByOrigin(e);return Object.values(t.sort((e,t)=>e.s-t.s).reduce(s,{})).flat()},this);return{stns:e,earliestTimeStamp:this.earliestTimeStamp,latestTimeStamp:this.latestTimeStamp}}smearEvtsByOrigin(e){let t=d[e][0],s=d[e][1],i={};return(r,n)=>{var a;let o=r[n.o];o||(o=r[n.o]=[]);let h=i[n.o];return"scrolling"!==e||(a=n)&&"number"==typeof a.e&&"number"==typeof a.s&&a.e-a.s<4?h&&n.s-h.s<s&&h.e>n.s-t?h.e=n.e:(i[n.o]=n,o.push(n)):(i[n.o]=null,n.n="scroll",o.push(n)),r}}processPVT(e,t,s){this.storeTiming({[e]:t})}storeTiming(e,t=!1){if(e)for(let s in e){let i=e[s],r=s.toLowerCase();!(r.indexOf("size")>=0||r.indexOf("status")>=0)&&"number"==typeof i&&i>=0&&(i=Math.round(i),this.parent.timeKeeper&&this.parent.timeKeeper.ready&&t&&(i=this.parent.timeKeeper.convertAbsoluteTimestamp(Math.floor(this.parent.timeKeeper.correctAbsoluteTimestamp(i)))),this.storeSTN(new(0,u.TraceNode)(s,i,i,"document","timing")))}}storeEvent(e,t,s,i){if(this.shouldIgnoreEvent(e,t)||this.prevStoredEvents.has(e))return;this.prevStoredEvents.add(e);let r=new(0,u.TraceNode)(this.evtName(e.type),s,i,void 0,"event");try{r.o=(0,h.eventOrigin)(e.target,t,this.parent.ee)}catch(e){r.o=(0,h.eventOrigin)(null,t,this.parent.ee)}this.storeSTN(r)}shouldIgnoreEvent(e,t){if(e.type in m.global)return!0;let s=(0,h.eventOrigin)(e.target,t,this.parent.ee);return!!m[s]&&!!m[s].ignoreAll||!!(m[s]&&e.type in m[s])}evtName(e){switch(e){case"keydown":case"keyup":case"keypress":return"typing";case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mouseout":return"mousing";case"scroll":return"scrolling";case"touchstart":case"touchmove":case"touchend":case"touchcancel":case"touchenter":case"touchleave":return"touching";default:return e}}storeHist(e,t,s){this.storeSTN(new(0,u.TraceNode)("history.pushState",s,s,e,t))}#t=0;storeResources(e){e&&0!==e.length&&(e.forEach(e=>{if((0|e.fetchStart)<=this.#t)return;let{initiatorType:t,fetchStart:s,responseEnd:i,entryType:r}=e,{protocol:n,hostname:a,port:h,pathname:c}=(0,o.parseUrl)(e.name),l=new(0,u.TraceNode)(t,0|s,0|i,"".concat(n,"://").concat(a,":").concat(h).concat(c),r);this.storeSTN(l)}),this.#t=0|e[e.length-1].fetchStart)}storeErrorAgg(e,t,s,i){"err"===e&&this.storeSTN(new(0,u.TraceNode)("error",i.time,i.time,s.message,s.stackHash))}storeXhrAgg(e,t,s,i){"xhr"===e&&this.storeSTN(new(0,u.TraceNode)("Ajax",i.time,i.time+i.duration,"".concat(s.status," ").concat(s.method,": ").concat(s.host).concat(s.pathname),"ajax"))}isEmpty(){return 0===this.nodeCount}save(){this.#e=this.trace}get(){return[{targetApp:this.parent.agentRef.runtime.entityManager.get(),data:this.takeSTNs()}]}clear(){this.trace={},this.nodeCount=0,this.prevStoredEvents.clear(),this.earliestTimeStamp=1/0,this.latestTimeStamp=0}reloadSave(){Object.values(this.#e).forEach(e=>e.forEach(e=>this.storeSTN(e)))}clearSave(){this.#e=void 0}}}),s("aDRsS",function(t,s){e(t.exports,"eventOrigin",function(){return i});function i(e,t,s){let i="unknown";if(e&&e instanceof XMLHttpRequest){let t=s.context(e).params;if(!t||!t.status||!t.method||!t.host||!t.pathname)return"xhrOriginMissing";i=t.status+" "+t.method+": "+t.host+t.pathname}else if(e&&"string"==typeof e.tagName&&(i=e.tagName.toLowerCase(),e.id&&(i+="#"+e.id),e.className))for(let t=0;t<e.classList.length;t++)i+="."+e.classList[t];return"unknown"===i&&("string"==typeof t?i=t:t===document?i="document":t===window?i="window":t instanceof FileReader&&(i="FileReader")),i}}),s("6xUcd",function(t,s){e(t.exports,"TraceNode",function(){return i});class i{constructor(e,t,s,i,r){this.n=e,this.s=t,this.e=s,this.o=i,this.t=r}}}),s("hcIxM",function(t,s){e(t.exports,"applyFnToProps",function(){return function e(t,s,i="string",r=[]){return t&&"object"==typeof t&&Object.keys(t).forEach(n=>{"object"==typeof t[n]?e(t[n],s,i,r):typeof t[n]!==i||r.includes(n)||(t[n]=s(t[n]))}),t}})});
//# sourceMappingURL=aggregate.0f378ce2.js.map
